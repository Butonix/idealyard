<template>
  <div id="write" v-title :data-title="title">
    <el-container>
      <base-header :simple=true>
        <el-col :span="4" :offset="2">
          <div class="me-write-info">ÂÜôÊñáÁ´†</div>
        </el-col>
        <el-col :span="4" :offset="6">
          <div class="me-write-btn">
            <el-button round @click="publishShow">ÂèëÂ∏É</el-button>
            <el-button round @click="cancel">ÂèñÊ∂à</el-button>
          </div>
        </el-col>
      </base-header>

      <el-container class="me-area me-write-box">
        <el-main class="me-write-main">
          <div class="me-write-title">
            <el-input resize="none"
                      type="textarea"
                      autosize
                      v-model="articleForm.title"
                      placeholder="ËØ∑ËæìÂÖ•Ê†áÈ¢ò"
                      class="me-write-input">
            </el-input>

          </div>
          <div id="placeholder" style="visibility: hidden;height: 89px;display: none;"></div>
          <markdown-editor :editor="articleForm.editor" class="me-write-editor"></markdown-editor>
        </el-main>
      </el-container>

      <el-dialog title="ÊëòË¶Å ÂàÜÁ±ª Ê†áÁ≠æ"
                 :visible.sync="publishVisible"
                 :close-on-click-modal=false
                 custom-class="me-dialog">

        <el-form :model="articleForm" ref="articleForm" :rules="rules">
          <el-form-item prop="summary">
            <el-input type="textarea"
                      v-model="articleForm.summary"
                      :rows="6"
                      placeholder="ËØ∑ËæìÂÖ•ÊëòË¶Å">
            </el-input>
          </el-form-item>
          <el-form-item label="ÊñáÁ´†ÂàÜÁ±ª" prop="category">
            <!--https://element.eleme.cn/#/zh-CN/component/select#chuang-jian-tiao-mu-->
            <!--<el-select v-model="articleForm.category" value-key="id" placeholder="ËØ∑ÈÄâÊã©ÊñáÁ´†ÂàÜÁ±ª">-->
              <!--<el-option v-for="c in categories" :key="c.id" :label="c.categoryname" :value="c"></el-option>-->
            <!--</el-select>-->
            <el-select
              v-model="articleForm.category"
              filterable
              allow-create
              default-first-option
              placeholder="ËØ∑ÈÄâÊã©ÊñáÁ´†ÂàÜÁ±ª">
              <el-option
                v-for="item in categories"
                :key="item.id"
                :label="item.categoryname"
                :value="item.categoryname">
              </el-option>
            </el-select>
          </el-form-item>

          <el-form-item label="ÊñáÁ´†Ê†áÁ≠æ" prop="tags">
            <el-tag
              :key="tag"
              v-for="tag in dynamicTags"
              closable
              :disable-transitions="false"
              @close="handleClose(tag)">
              {{tag}}
            </el-tag>
            <el-input
              class="input-new-tag"
              v-if="inputVisible"
              v-model="inputValue"
              ref="saveTagInput"
              size="small"
              @keyup.enter.native="handleInputConfirm"
              @blur="handleInputConfirm"
            >
            </el-input>
            <!--TODO:Ê∑ªÂä†Ê∏ÖÁ©∫ÊâÄÊúâÁöÑÊåâÈíÆ-->
            <el-button v-else class="button-new-tag" size="small" @click="showInput">+ New Tag</el-button>
            <!--<el-checkbox-group v-model="articleForm.tags">-->
              <!--<el-checkbox v-for="t in tags" :key="t.id" :label="t.id" name="tags">{{t.tagname}}</el-checkbox>-->
            <!--</el-checkbox-group>-->
          </el-form-item>
        </el-form>
        <div slot="footer" class="dialog-footer">
          <el-button @click="publishVisible = false">Âèñ Ê∂à</el-button>
          <el-button type="primary" @click="publish('articleForm')">ÂèëÂ∏É</el-button>
        </div>
      </el-dialog>
    </el-container>
  </div>
</template>

<script>
  import BaseHeader from '@/views/BaseHeader'
  import MarkdownEditor from '@/components/markdown/MarkdownEditor'
  import {publishArticle, reqArticleById} from '@/api/article'
  import {reqAllCategories} from '@/api/category'
  import {reqHotTags} from '@/api/tag'

  export default {
    name: 'BlogWrite',
    mounted() {

      if(this.$route.params.id){
        this.getArticleById(this.$route.params.id)
      }

      this.getCategorysAndTags()
      this.editorToolBarToFixedWrapper = this.$_.throttle(this.editorToolBarToFixed, 200)
      window.addEventListener('scroll', this.editorToolBarToFixedWrapper, false);
    },
    beforeDestroy() {
      window.removeEventListener('scroll', this.editorToolBarToFixedWrapper, false)
    },
    data() {
      return {
        options: [{
          value: 'HTML',
          label: 'HTML'
        }, {
          value: 'CSS',
          label: 'CSS'
        }, {
          value: 'JavaScript',
          label: 'JavaScript'
        }],
        dynamicTags: [],
        inputVisible: false,
        inputValue: '',
        publishVisible: false,
        userVisableTags: [],
        categories: [],
        articleForm: {
          id: '',
          title: '',
          summary: '',
          category: '',
          tags: [],
          editor: {
            value: '',
            ref: '',//‰øùÂ≠òmavonEditorÂÆû‰æã  ÂÆûÈôÖ‰∏çËØ•ËøôÊ†∑
            default_open: 'edit',
            toolbars: {
              bold: true, // Á≤ó‰Ωì
              italic: true, // Êñú‰Ωì
              header: true, // Ê†áÈ¢ò
              underline: true, // ‰∏ãÂàíÁ∫ø
              strikethrough: true, // ‰∏≠ÂàíÁ∫ø
              mark: true, // Ê†áËÆ∞
              superscript: true, // ‰∏äËßíÊ†á
              subscript: true, // ‰∏ãËßíÊ†á
              quote: true, // ÂºïÁî®
              ol: true, // ÊúâÂ∫èÂàóË°®
              ul: true, // Êó†Â∫èÂàóË°®
              imagelink: true, // ÂõæÁâáÈìæÊé•
              code: true, // code
              fullscreen: true, // ÂÖ®Â±èÁºñËæë
              readmodel: true, // Ê≤âÊµ∏ÂºèÈòÖËØª
              help: true, // Â∏ÆÂä©
              undo: true, // ‰∏ä‰∏ÄÊ≠•
              redo: true, // ‰∏ã‰∏ÄÊ≠•
              trash: true, // Ê∏ÖÁ©∫
              navigation: true, // ÂØºËà™ÁõÆÂΩï
              //subfield: true, // ÂçïÂèåÊ†èÊ®°Âºè
              preview: true, // È¢ÑËßà
            }
          }
        },
        rules: {
          summary: [
            {required: true, message: 'ËØ∑ËæìÂÖ•ÊëòË¶Å', trigger: 'blur'},
            {max: 80, message: '‰∏çËÉΩÂ§ß‰∫é80‰∏™Â≠óÁ¨¶', trigger: 'blur'}
          ],
          category: [
            {required: true, message: 'ËØ∑ÈÄâÊã©ÊñáÁ´†ÂàÜÁ±ª', trigger: 'change'}
          ],
          tags: [
            // {type: 'array', required: true, message: 'ËØ∑ÈÄâÊã©Ê†áÁ≠æ', trigger: 'change'}
            {type: 'array', message: 'ËØ∑ÈÄâÊã©Ê†áÁ≠æ', trigger: 'change'}
          ]
        }
      }
    },
    computed: {
      title (){
        return 'ÂÜôÊñáÁ´† - For Fun'
      }
    },

    methods: {
      handleClose(tag) {
        this.dynamicTags.splice(this.dynamicTags.indexOf(tag), 1);
      },
      showInput() {
        this.inputVisible = true;
        this.$nextTick(_ => {
          this.$refs.saveTagInput.$refs.input.focus();
        });
      },
      // TODO:https://www.jianshu.com/p/24f3320d3d40
      handleInputConfirm() {
        let inputValue = this.inputValue;
        if (inputValue) {
          // ÂØπÁî®Êà∑ËæìÂÖ•ÂÄºËøõË°åÂàáÂàÜ
          let values = inputValue.split(/[,Ôºå \n]/).filter(item=>{
            return item!='' && item!=undefined
          })
          // ÂØπÂàóË°®Á¥¢ÂºïÔºåÊ≤°ÊúâÊâæÂà∞Âàôpush
          values.forEach(element => {
            let index = this.dynamicTags.findIndex(i=>{
            return i === element
          })
          if(index<0){
           this.dynamicTags.push(element);
          }
        });
      }
      this.inputVisible = true;
      this.inputValue = '';
      },
      getArticleById(id) {
        console.log('-------getArticleById-----',id)
        let that = this
        reqArticleById(id).then(data => {

          Object.assign(that.articleForm, data.data)
          that.articleForm.editor.value = data.data.body.content

          let tags = this.articleForm.tags.map(function (item) {
            return item.id;
          })

          this.articleForm.tags = tags

        }).catch(error => {
          if (error !== 'error') {
            that.$message({type: 'error', message: 'ÊñáÁ´†Âä†ËΩΩÂ§±Ë¥•', showClose: true})
          }
        })
      },
      publishShow() {
        console.log(this.articleForm.tags)
        if (!this.articleForm.title) {
          this.$message({message: 'Ê†áÈ¢ò‰∏çËÉΩ‰∏∫Á©∫Âì¶ üëÄ', type: 'warning', showClose: true})
          return
        }

        if (this.articleForm.title.length > 30) {
          this.$message({message: 'Ê†áÈ¢ò‰∏çËÉΩÂ§ß‰∫é30‰∏™Â≠óÁ¨¶', type: 'warning', showClose: true})
          return
        }

        if (!this.articleForm.editor.ref.d_render) {
          this.$message({message: 'ÂÜÖÂÆπË¶ÅÊª°Êª°ÁöÑËØöÊÑèÂì¶ üòú', type: 'warning', showClose: true})
          return
        }

        this.publishVisible = true;
      },
      publish(articleForm) {

        let that = this

        this.$refs[articleForm].validate((valid) => {
          if (valid) {

            let tags = this.articleForm.tags.map(function (item) {
              return {id: item};
              // TODO: just for test
            });
            console.log('---this.articleForm.id----------',this.articleForm.id)
            console.log('---this.articleForm.id----------',tags)
            console.log('---this.articleForm.title----------',this.articleForm.title)
            let article = {
              id: this.articleForm.id,
              title: this.articleForm.title,
              summary: this.articleForm.summary,
              category: this.articleForm.category,
              dynamicTags: this.dynamicTags,
              tags: this.userVisableTags,
              body: {
                content: this.articleForm.editor.value,
                contentHtml: this.articleForm.editor.ref.d_render
              }

            }
            // ÂÖ≥Èó≠ÂèëÂ∏ÉÊ°Ü
            this.publishVisible = false;

            let loading = this.$loading({
              lock: true,
              text: 'ÂèëÂ∏É‰∏≠ÔºåËØ∑Á®çÂêé...'
            })

            publishArticle(article).then((data) => {
              loading.close();
              that.$message({message: 'ÂèëÂ∏ÉÊàêÂäüÂï¶', type: 'success', showClose: true})
              that.$router.push({path: `/view/${data.data.articleId}`})

            }).catch((error) => {
              loading.close();
              if (error !== 'error') {
                that.$message({message: error, type: 'error', showClose: true});
              }
            })

          } else {
            return false;
          }
        });
      },
      cancel() {
        this.$confirm('ÊñáÁ´†Â∞Ü‰∏ç‰ºö‰øùÂ≠ò, ÊòØÂê¶ÁªßÁª≠?', 'ÊèêÁ§∫', {
          confirmButtonText: 'Á°ÆÂÆö',
          cancelButtonText: 'ÂèñÊ∂à',
          type: 'warning'
        }).then(() => {
          this.$router.push('/')
        })
      },
      getCategorysAndTags() {
        let that = this
        reqAllCategories().then(data => {
          that.categories = data.data
        }).catch(error => {
          if (error !== 'error') {
            that.$message({type: 'error', message: 'ÊñáÁ´†ÂàÜÁ±ªÂä†ËΩΩÂ§±Ë¥•', showClose: true})
          }
        })
        // Âè™ÊòæÁ§∫ÁÉ≠Èó®Ê†áÁ≠æÔºåÊ≤°ÊúâÂøÖË¶ÅÊääÊâÄÊúâÊ†áÁ≠æÈÉΩÂàóÂá∫Êù•ÔºåËÆ©Áî®Êà∑ÂèØ‰ª•Ëá™‰∏ªÊ∑ªÂä†Êõ¥Â•Ω
        reqHotTags().then(data => {
          that.tags = data.data
          that.tags.forEach(tag => {
            console.log('$$$$$$$$$$$',tag)
            // ‰øùÂ≠òÁî®Êà∑ÊúÄÁªàÊ∑ªÂä†ÁöÑtags
            this.dynamicTags.push(tag.tagname)
            // ‰øùÂ≠òÁî®Êà∑ÂèØËßÅtags
            this.userVisableTags.push(tag.tagname)
          })
          console.log('-------reqAllTags------1111-----',this.dynamicTags)
        }).catch(error => {
          if (error !== 'error') {
            that.$message({type: 'error', message: 'Ê†áÁ≠æÂä†ËΩΩÂ§±Ë¥•', showClose: true})
          }
        })

      },
      editorToolBarToFixed() {

        let toolbar = document.querySelector('.v-note-op');
        let curHeight = document.documentElement.scrollTop || document.body.scrollTop;
        if (curHeight >= 160) {
          document.getElementById("placeholder").style.display = "block"; //bad  Áî®ËÆ°ÁÆóÂ±ûÊÄßËæÉÂ•Ω
          toolbar.classList.add("me-write-toolbar-fixed");
        } else {
          document.getElementById("placeholder").style.display = "none";
          toolbar.classList.remove("me-write-toolbar-fixed");
        }
      }
    },
    components: {
      'base-header': BaseHeader,
      'markdown-editor': MarkdownEditor
    },
    //ÁªÑ‰ª∂ÂÜÖÁöÑÂÆàÂç´ Ë∞ÉÊï¥bodyÁöÑËÉåÊôØËâ≤
    beforeRouteEnter(to, from, next) {
      window.document.body.style.backgroundColor = '#fff';
      next();
    },
    beforeRouteLeave(to, from, next) {
      window.document.body.style.backgroundColor = '#f5f5f5';
      next();
    }
  }
</script>

<style>
  .el-header {
    position: fixed;
    z-index: 1024;
    min-width: 100%;
    box-shadow: 0 2px 3px hsla(0, 0%, 7%, .1), 0 0 0 1px hsla(0, 0%, 7%, .1);
  }

  .me-write-info {
    line-height: 60px;
    font-size: 18px;
    font-weight: 600;
  }

  .me-write-btn {
    margin-top: 10px;
  }

  .me-write-box {
    max-width: 700px;
    margin: 80px auto 0;
  }

  .me-write-main {
    padding: 0;
  }

  .me-write-title {
  }

  .me-write-input textarea {
    font-size: 32px;
    font-weight: 600;
    height: 20px;
    border: none;
  }

  .me-write-editor {
    min-height: 650px !important;
  }

  .me-header-left {
    margin-top: 10px;
  }

  .me-title img {
    max-height: 2.4rem;
    max-width: 100%;
  }

  .me-write-toolbar-fixed {
    position: fixed;
    width: 700px !important;
    top: 60px;
  }

  .v-note-op {
    box-shadow: none !important;
  }

  .auto-textarea-input, .auto-textarea-block {
    font-size: 18px !important;
  }
  .el-tag{
    margin-right: 10px;
  }
  .el-tag + .el-tag {
    margin-left: 10px;
  }
  .button-new-tag {
    margin-left: 10px;
    height: 32px;
    line-height: 30px;
    padding-top: 0;
    padding-bottom: 0;
  }
  .input-new-tag {
    /*width: 90px;*/
    width: 60%;
    display:block;
    vertical-align: bottom;
  }
</style>
